<!DOCTYPE html>
<html>

  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>  
  
   <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0' />
    <title>Torn Tracks Locations</title>
    <%= stylesheet_link_tag('application', :media => 'all') %>
    <%= javascript_include_tag('application') %>
    
    <script>
      $(document).on("turbolinks:load", function() {
         const player = new Plyr('#player');
         $('.content').on('click', '.newsound', function(event) {
           event.preventDefault();
           var arglink = $(this).data('arglink');
           var argtitle = $(this).data('argtitle');
           player.source = {
               type: 'audio',
               title: argtitle,
               sources: [
                   {
                       src: arglink,
                       type: 'audio/mpeg',
                   },
               ],
           };
           document.getElementById("curraudiotitle").innerHTML = 'Now playing: Track # '+argtitle;
           player.play();
          })
       });
    </script>

<script type="application/geo+json" id="geo-data">
{
  "type": "FeatureCollection",
  "features": [
  <% @tracks.each do |track| %>
    <% if track.sound.exists? %>
    {"type": "Feature",
    "properties": {
      "title": "<%= track.name %>",
      "audio_url": "<%= track.sound %>",
      "marker-symbol": "commercial",
        "marker-size": "large",
        "marker-color": "c4ba6a"
    },
    "geometry": {
      "type": "Point",
      "coordinates": [<%= track.longitude %>, <%= track.latitude %>]
    }},
    <% end %>
  <% end %>
  {}
  ]
}
</script>

<script type="text/html" id="popup-template">
<div class="audio-popup">
    <h2>{{= title }}</h2>
    <audio src="{{= audio_url }}" controls ></audio>
</div>
</script>

  </head>

  <body>
      <div class="page locations">
        <div class="menu">
            <button class="button"><%= link_to("<<", public_index_path) %></button>
            <button id="button">i</button>

          
        </div>

        <div class="content">
          <%= yield %>
          </div>

          <div id="myModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <p>&nbsp;</p>
                <p>This map shows the places where the various tracks have been
                  made. The place where they have (mainly) been put together, recorded or performed.</p>
                <p>&nbsp;</p>
            </div>
          </div>
        
        

        <div class="clear"></div>
      </div>

      <div class="footer">
        <p id="copyright">&copy; Jiska Huizing <%= Date.today.year %></p>
      </div>
  </body>

  <script src="https://cdn.jsdelivr.net/lodash/4.16.2/lodash.min.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
  </script>

  <script>
  _.templateSettings = {
    interpolate: /\{\{\=(.+?)\}\}/g,
    evaluate: /\{\{(.+?)\}\}/g
  };

  var map = L.map('OSMmap').setView([51.505, -0.09], 9);

  var popup_template = _.template(window.document.querySelector('#popup-template').innerText);

  var geo_data = JSON.parse(window.document.querySelector('#geo-data').innerText);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  var greenIcon = L.icon({
    iconUrl: '/assets/finger.png',
    iconSize:     [38, 95],
    iconAnchor:   [22, 94], 
    popupAnchor:  [-3, -76] 
  });

  L.geoJson(geo_data, {
    onEachFeature: function (feature, layer) {
        if (feature.properties && feature.properties.audio_url) {
            layer.bindPopup(popup_template(feature.properties));
        }
        else if (feature.properties && feature.properties.popupContent) {
            layer.bindPopup(feature.properties.popupContent);
        }
    },
    pointToLayer: function (feature, latlng) {
        return L.marker(latlng, {icon: greenIcon});
    }
  }).addTo(map);

// frame and whatever else 

  </script>

  <script>
    // Get the modal
    var modal = document.getElementById('myModal');
    // Get the button that opens the modal
    var btn = document.getElementById("button");
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];
    // When the user clicks on the button, open the modal
    btn.onclick = function() {modal.style.display = "block";}
    // When the user clicks on <span> (x), close the modal
    span.onclick = function() { modal.style.display = "none"; }
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
          modal.style.display = "none";
        }
      }
  </script>

</html>
